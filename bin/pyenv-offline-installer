#!/usr/bin/env bash

set -e
[ -n "$PYENV_DEBUG" ] && set -x

if [ -z "$PYENV_ROOT" ]; then
  PYENV_ROOT="${HOME}/.pyenv"
fi

SRC_WRITTEN=false

colorize() {
  if [ -t 1 ]; then printf "\e[%sm%s\e[m" "$1" "$2"
  else echo -n "$2"
  fi
}

# Checks for `.pyenv` file, and suggests to remove it for installing
if [ -d "${PYENV_ROOT}" ]; then
  { echo
    colorize 1 "WARNING"
    echo ": Can not proceed with installation. Kindly remove '.pyenv' from ${HOME} first."
    echo
  } >&2
    exit 1
fi

conditional_mv() {
  [ -d "$2" ] || mkdir -p "$2" && mv "$1"/* "$2"
}

if ! command -v git 1>/dev/null 2>&1; then
  echo "pyenv: Git is not installed, can't continue." >&2
  exit 1
fi

# PYENV_PACKAGE_ARCHIVE is the path of pyenv compressed archive file.
if [ -z "$PYENV_PACKAGE_ARCHIVE" ]; then
  PYENV_PACKAGE_ARCHIVE="$(cd $(dirname "$0") && pwd)/pyenv-package.tar.gz"
fi

if [ ! -e "$PYENV_PACKAGE_ARCHIVE" ]; then
  { echo
    colorize 1 "ERROR"
    echo ": file $PYENV_PACKAGE_ARCHIVE not exists."
    echo
  } >&2
  exit 1
fi

# Decompress archive.
TMP_DIR=$(mktemp -d)

tar -xf "$PYENV_PACKAGE_ARCHIVE" -C "$TMP_DIR"

conditional_mv "$TMP_DIR/pyenv"            "${PYENV_ROOT}"
conditional_mv "$TMP_DIR/pyenv-doctor"     "${PYENV_ROOT}/plugins/pyenv-doctor"
conditional_mv "$TMP_DIR/pyenv-installer"  "${PYENV_ROOT}/plugins/pyenv-installer"
conditional_mv "$TMP_DIR/pyenv-update"     "${PYENV_ROOT}/plugins/pyenv-update"
conditional_mv "$TMP_DIR/pyenv-virtualenv" "${PYENV_ROOT}/plugins/pyenv-virtualenv"
conditional_mv "$TMP_DIR/pyenv-which-ext"  "${PYENV_ROOT}/plugins/pyenv-which-ext"

rm -rf $TMP_DIR

write_source() {
  {
    echo "Appending the following lines to $1:"
    echo '  # pyenv'
    echo '  export PATH="'"$PYENV_ROOT/bin:"'$PATH"'
    echo '  eval "$(pyenv init --path)"'
    echo '  eval "$(pyenv virtualenv-init -)"'
    echo ''
  } >&2

  echo "" >>$1
  echo '# pyenv' >>$1
  echo 'export PATH="'"$PYENV_ROOT/bin:"'$PATH"' >>$1
  echo 'eval "$(pyenv init --path)"' >>$1
  echo 'eval "$(pyenv virtualenv-init -)"' >>$1

  SRC_WRITTEN=true
}

add_userpath() {
  OS="$(uname -s)"
  CURRENT_SHELL="$(basename "$SHELL")"

  if [[ "$OS" = "Darwin" ]]; then
    if [[ "$CURRENT_SHELL" = "zsh" ]]; then
      write_source "$HOME/.zprofile"
    elif [[ "$CURRENT_SHELL" = "bash" ]]; then
      write_source "$HOME/.bash_profile"
    fi

  elif [[ "$CURRENT_SHELL" = "zsh" ]]; then
    # write to first match: zshrc/zprofile
    if [[ -f $HOME/.zshrc ]]; then
      write_source "$HOME/.zshrc"
    elif [[ -f $HOME/.zprofile ]]; then
      write_source "$HOME/.zprofile"
    fi

  elif [[ "$CURRENT_SHELL" = "bash" ]]; then
    # bashrc
    write_source "$HOME/.bashrc"

    # write to first match: profile/bash_profile
    if [[ -f $HOME/.profile ]]; then
      write_source "$HOME/.profile"
    elif [[ -f $HOME/.bash_profile ]]; then
      write_source "$HOME/.bash_profile"
    fi

  else
    {
      echo "Add userpath for $CURRENT_SHELL is not currently supported"
      echo "Please set up manually"
    } >&2
  fi
}

if ! command -v pyenv 1>/dev/null; then
  add_userpath

  if ${SRC_WRITTEN}; then
    echo "Close and reopen your terminal to start using pyenv" >&2
  else
    { echo
      colorize 1 "WARNING"
      echo ": seems you still have not added 'pyenv' to the load path."
      echo
    } >&2

    { # Without args, `init` commands print installation help
      "${PYENV_ROOT}/bin/pyenv" init || true
      "${PYENV_ROOT}/bin/pyenv" virtualenv-init || true
    } >&2
  fi
fi
